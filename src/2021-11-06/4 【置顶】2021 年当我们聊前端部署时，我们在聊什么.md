# 2021 年当我们聊前端部署时，我们在聊什么

- 前端代码从 tsx/jsx 到部署上线被用户访问，中间大致会经历哪些过程？
- 上述过程中分别都有哪些考虑、指标和优化点，以满足复杂的业务需求？
- 可能大部分同学都知道强缓存/协商缓存，那前端各种产物（HTML、JS、CSS、IMAGES 等）应该用什么缓存策略？以及为什么？

1. 若使用协商缓存，但静态资源却不频繁更新，如何避免协商过程的请求浪费？
2. 若使用强缓存，那静态资源如何更新？

- 配套的，前端静态资源应该如何组织？
- 配套的，自动化构建 & 部署过程如何与 CDN 结合？
- 如何避免前端上线，影响未刷新页面的用户？
- 刚上线的版本发现有阻塞性 bug，如何做到秒级回滚，而非再次部署等 20 分钟甚至更久？
- 如何实现一个预发环境，除了前端资源外都是线上环境，将变量控制前端环境内？
- 部署环节如何方便配套做 AB 测试等？
- 如何实现一套前端代码，发布成多套环境产物？
- 如何实现按 feature 发布产物供用户使用，并逐步扩大 feature 灰度，将影响减到最小（即线上同时存在多 feature 产物）？
- CDN 域名突然挂了，如何实现秒级 CDN 降级修补而非再次全部业务重新部署一次？


##### 缓存更新问题

鉴于页面（index.html）会频繁更新，而静态资源则相对稳定。所以，我们能推断出的一种缓存策略是 index.html 适合走协商缓存，相对稳定 & 不常更新的静态资源（JS、CSS、IMAGES） 等应该消灭协商请求，使用强缓存。
然而问题很快就来了，都不让浏览器发请求，但缓存还未到期我们发现有 bug，想更新 foo.css 怎么办？

相信大家很快就能得出一种思路，给资源加版本号！比如通过 query 加版本号，每次上线统一改版本号就搞定了。此时 HTML 变成如图：

统一加版本号的优点是简单粗暴快捷，但缺点则是：假如我们只想更新 foo.css，但 bar.css 缓存也失效了，又造成了带宽的浪费。

大家应该很快就能想到办法，需要将文件内容与版本号（URL）绑定，当文件内容发生变更时才变更版本号（URL），这样就能实现每个文件精确的缓存控制。

什么东西与文件内容相关呢？ 消息摘要算法 ，对文件求摘要信息，**摘要信息与文件内容一一对应**，就有了一种可以精确到单个文件粒度的缓存控制依据。现在，我们把 URL 改成带文件摘要信息的：

我们可以称这种这个方式为 query-hash，后续发版上线时，只有被变更文件的 URL 会更新，实现了精确的缓存控制，完美！

##### 覆盖式发布引发的问题

然而假如我们就按上述部署方案就上了线，很快就会 Fatal 满天飞，每次更新上线都可能会出现灾难。
我们回顾一下，网站的静态文件只有一份，部署在 Nginx 服务器某目录下，并且通过 query-hash 的方式实现按文件做精确缓存控制，问题出在哪了呢？

回顾一下，我们某次更新时，更改了 foo.css 样式，此时会将 HTML 中的foo.css url更新为最新的 hash，并将服务器中存储的 foo.css & index.html 文件覆盖为最新（V2版本），看似HTML和静态资源都对应更新了，但是没有考虑极端情况。那就是：

- 先部署静态资源，部署期间访问时，会出现V1版本HTML访问到V2版本新静态资源，并按V1-hash缓存起来。
- 先部署HTML，部署期间访问时，会出现V2版本HTML访问到V1版本旧静态资源，并按V2-hash缓存起来。


对于问题1，会有两种子Case：

- 用户本地有缓存，此时无影响可正常访问。
- 用户本地无缓存，则会将V2版本静态资源加载并按V1版本 hash 缓存起来。用户报错。当V2版本HTML部署完成后，用户再次访问时恢复


解决问题方案也极其简单，使用非覆盖式发布，一种简单的改造方式是将文件摘要（hash）放置到URL 中，即将 query-hash 改为 name-hash。

这样，每次部署时先全量部署静态资源，再灰度部署页面，就能比较完美的解决了缓存的问题。

> 此时，服务器上会存在多份 foo.[$hash].css 文件


#### 与 CDN 结合
现在我们开开心心将网站部署上线了，但我们此时仍然将静态资源部署在 Nginx 服务器目录下，然后新的问题来了，随着时间推移，非覆盖部署导致文件逐渐增加多，硬盘逐渐吃紧。而且将文件存储在 Nginx Web服务器内某目录下，深度的将 Nginx、网站、部署过程等强耦合在一起，无法使用 CDN 技术。

作者：字节架构前端
链接：https://juejin.cn/post/7017710911443959839
来源：稀土掘金
著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。

> CDN 是一种内容分发网络，部署在应用层，利用智能分配技术，根据用户访问的地点，按照就近访问的原则分配到多个节点，来实现多点负载均衡。
> 简单来说，用户就近访问，访问速度更快，大公司也无需搞一台超级带宽的存储服务器，只需使用多台正常带宽的 CDN 节点即可。
> 而 CDN 的常见实现是有一台源站服务器，多个 CDN 节点定时从源站同步。

那如何将 CDN 与 Nginx 等 Web 服务器结合呢？

答案是将静态资源部署到 CDN 上，再将 Nginx 上的流量转发到 CDN 上，这种技术我们称之为『反向代理』。

此时，我们总体部署方案需要进一步做三步改造。

- 构建时依据环境变量，将 HTML 中的静态资源地址加上 CDN 域名。
- 构建完成后将静态资源上传到 CDN 。
- 配置 Nginx 的反向代理，将静态资源流量转发到 CDN。

其中，第 1、2 条涉及构建过程调整，以 Webpack 为例，我们需要做以下配置改造：

- a.  配置 `output` 为 `content-hash` & `publicPath`  
- b.  配置 `Webpack-HTML-Plugin`


```js
// webpack.config.js
const CDN_HOST = process.env.CDN_HOST;// CDN 域名
const CDN_PATH = process.env.CDN_PATH; // CDN 路径
const ENV = process.env.ENV; // 当前的环境等等
const VERSION = process.env.VERSION; // 当前发布的版本

const getPublicPath = () => {
    // Some code here
    return `${CDN_HOST}/${CDN_PATH}/${ENV}/`;// 依据 ENV 等动态构造 publicPath
}

const publicPath = process.env.NODE_ENV === 'production' ? getPublicPath() : '.';

module.exports = {
    output: {
        filename: 'bundle.[name][contenthash:8].js',
        publicPath,
    },
    plugins: [
        new HtmlWebpackPlugin()
    ]
}

```

构建完成后静态资源上传 CDN 源站

上传 CDN 源站往往通过 CLI 调用各种客户端工具上传，此时要注意的是上传 CDN 依赖配置鉴权信息（如 文件存储的 Bucket Name/accessKey、ftp的账号密码）。这些鉴权信息不能直接写代码里，否则可能会有事故风险（想想为什么）！
第 3 步改造是 Nginx 层反向代理改造


反向代理（reverse proxy）：是指以代理服务器来接受网络请求，并将请求转发给内部的服务器，并且将内部服务器的返回，就像是二房东一样。

一句话解释反向代理 & 正向代理：反向代理隐藏了真正的服务器，正向代理隐藏了真正的客户端。
详见：漫话：如何给女朋友解释什么是反向代理？


### 静态资源组织总结

- 为了最大程度利用缓存，将页面入口(HTML)设置为协商缓存，将 JavaScript、CSS 等静态资源设置为永久强缓存。
- 为了解决强缓存更新问题，将文件摘要（hash）作为资源路径(URL)构成的一部分。
- 为了解决覆盖式发布引发的问题，采用 name-hash 而非 query-hash 的组织方式，具体需要配置 Wbpack 的 output.filename 为 contenthash 。
- 为了解决 Nginx 目录存储过大 + 结合 CDN 提升访问速度，采用了 Nginx 反向代理+ 将静态资源上传到 CDN。
- 为了上传 CDN，我们需要按环境动态构造 publicPath + 按环境构造 CDN 上传目录并上传。
- 为了动态构造 publicPath 并且随构建过程插入到 HTML 中，采用 Webpack-HTML-Plugin 等插件，将编译好的带 hash + publicPath 的静态资源插入到 HTML 中。
- 为了保证上传 CDN 的安全，我们需要一种机制管控上传 CDN 秘钥，而非简单的将秘钥写到代码 / Dockerfile 等明文文件中。
- 


## 自动化构建



作者：字节架构前端
链接：https://juejin.cn/post/7017710911443959839
来源：稀土掘金
著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。